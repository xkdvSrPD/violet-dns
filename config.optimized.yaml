# Optimized DNS Server Configuration
# Based on best practices from sing-box, Xray-core, mihomo

# Server Configuration
server:
  port: 10053
  protocol: udp  # or: tcp, both
  bind: 0.0.0.0  # Listen address

# Bootstrap DNS for resolving nameserver hostnames
bootstrap:
  nameservers:
    - 223.5.5.5
    - 119.29.29.29
  timeout: 5s

# Upstream DNS Groups
upstream_group:
  # Foreign DNS through proxy
  proxy:
    nameservers:
      - https://1.1.1.1/dns-query
      - https://8.8.8.8/dns-query
      - quic://dns.adguard.com
    outbound: hk
    strategy: prefer_ipv4  # ipv4_only, ipv6_only, prefer_ipv4, prefer_ipv6
    concurrent_queries: true  # Query A and AAAA in parallel
    enable_ecs: false  # Don't send ECS to foreign DNS for privacy
    timeout: 5s
    fallback_on_error: true

  # Foreign DNS through proxy with ECS (for CDN optimization)
  proxy_ecs:
    nameservers:
      - 8.8.8.8
      - https://8.8.8.8/dns-query
      - https://1.1.1.1/dns-query
    outbound: hk
    strategy: prefer_ipv4
    concurrent_queries: true
    force_ecs: true
    ecs_ip: 1.1.1.0/24  # Per-group ECS configuration
    timeout: 5s

  # Domestic DNS (direct connection)
  direct:
    nameservers:
      - system  # Use system resolver
      - 223.5.5.5  # Alibaba DNS
      - 119.29.29.29  # Tencent DNS
      - https://223.6.6.6/dns-query  # Alibaba DoH
    strategy: prefer_ipv4
    concurrent_queries: true
    enable_ecs: true
    ecs_ip: 113.132.219.0/24
    timeout: 3s

# Outbound (SOCKS5 Proxies)
outbound:
  - tag: direct
    type: direct  # Built-in, no proxy

  - tag: hk
    type: socks5
    enable: true
    server: 10.115.15.1
    port: 7890
    username: violet
    password: Dd112211
    udp: true  # Enable UDP over SOCKS5

  - tag: us
    type: socks5
    enable: true
    server: 10.115.15.1
    port: 7891
    username: violet
    password: Dd112211
    udp: true

# ECS (EDNS Client Subnet) Global Configuration
ecs:
  enable: true
  default_ipv4: 113.132.219.0/24
  default_ipv6: 2001:da8::/96
  ipv4_prefix: 24  # Send /24 prefix (hides last octet for privacy)
  ipv6_prefix: 96  # Send /96 prefix

# Cache Configuration
cache:
  dns_cache:
    enable: true
    clear: false  # IMPORTANT: Don't clear in production
    type: redis  # or: memory
    algorithm: arc  # Adaptive Replacement Cache (better than LRU)
    max_ttl: 86400  # Maximum cache TTL (24 hours)
    serve_stale: true  # Return stale data if upstream fails
    stale_ttl: 3600  # Keep stale entries for 1 hour
    negative_ttl: 300  # Cache NXDOMAIN for 5 minutes

  category_cache:
    enable: true
    clear: false
    type: redis
    ttl: 604800  # 7 days (categories rarely change)

# Redis Configuration
redis:
  server: 10.115.15.25
  port: 6379
  database: 7
  password: ""
  max_retries: 3
  pool_size: 10
  timeout: 5s

# Domain Categorization Policy
category_policy:
  preload:
    enable: true
    file: 'https://github.com/v2fly/domain-list-community/releases/latest/download/dlc.dat'
    update: '0 0 2 * * *'  # Update at 2 AM daily
    domain_group:
      proxy_site:
        - google
        - geolocation-!cn
        - geolocation-cn@!cn
        - category-scholar-!cn
      direct_site:
        - cn
        - geolocation-cn
        - apple-cn
        - category-games@cn
      game_domain:
        - category-games
      ads_site:
        - category-ads-all

# Query Routing Policy (matched top-down)
query_policy:
  # Game domains (low latency needed)
  - name: game_domain
    group: direct
    options:
      protocol: udp  # Prefer UDP for low latency
      disable_cache: true  # Always get fresh IPs

  # Block ads and trackers
  - name: ads_site
    group: block
    options:
      block_type: nxdomain  # or: noerror, 0.0.0.0

  # Foreign sites through proxy
  - name: proxy_site
    group: proxy
    options:
      protocol: auto  # Prefer DoH, fallback to UDP
      disable_ipv6: false
      rewrite_ttl: 3600  # Override TTL to 1 hour
      expected_ips:  # Only accept non-CN IPs
        - geoip:!cn
        - geoip:private
      fallback_group: direct

  # Domestic sites direct
  - name: direct_site
    group: direct
    options:
      protocol: auto
      ecs: 113.132.219.0/24  # Per-policy ECS override
      expected_ips:
        - geoip:cn

  # Unknown domains: intelligent fallback
  - name: unknown
    group: proxy_ecs_fallback
    options:
      fallback_timeout: 3s  # Wait max 3s for proxy_ecs
      auto_categorize: true  # Update category_cache based on result

# Fallback Configuration (for proxy_ecs_fallback policy)
fallback:
  geoip: 'https://raw.githubusercontent.com/Loyalsoldier/geoip/release/geoip.dat'
  asn: 'https://raw.githubusercontent.com/Loyalsoldier/geoip/release/GeoLite2-ASN.mmdb'
  update: '0 0 3 * * *'  # Update at 3 AM daily
  strategy: race  # Race both proxy_ecs and proxy
  timeout: 3s  # Max wait for proxy_ecs before using proxy result
  rule:
    - geoip:cn
    - geoip:private
    - asn:4134  # China Telecom
    - asn:4837  # China Unicom
    - asn:9808  # China Mobile
  # If IP matches rule â†’ use direct, else use proxy

# Performance Configuration
performance:
  singleflight: true  # Deduplicate concurrent identical queries
  query_timeout: 10s  # Overall query timeout
  max_concurrent_queries: 1000  # Prevent query storm
  prefetch: true  # Refresh cache before TTL expires (optional)
  prefetch_threshold: 0.1  # Refresh when 10% TTL remaining

# Logging Configuration
log:
  level: info  # debug, info, warn, error
  format: json  # or: text
  output: stdout  # or: file path

# Configuration Validation
validation:
  strict: true  # Fail on unknown config keys
  check_connectivity: true  # Test nameservers on startup
  check_files: true  # Verify geoip/dlc files downloadable

  warnings:
    large_domain_groups: 10000  # Warn if group >10k domains
    many_nameservers: 10  # Warn if >10 servers per group
    clear_cache_enabled: true  # Warn if clear: true
    missing_retry: true  # Warn if retry not configured
