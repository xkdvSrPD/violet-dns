# Optimized DNS Server Configuration
# Based on best practices from sing-box, Xray-core, mihomo

# Server Configuration
server:
  port: 10053
  protocol: udp  # or: tcp, both
  bind: 0.0.0.0  # Listen address

# Bootstrap DNS for resolving nameserver hostnames
bootstrap:
  nameservers:
    - 223.5.5.5
    - 119.29.29.29

# Upstream DNS Groups
upstream_group:
  # Foreign DNS through proxy (no ECS for privacy)
  proxy:
    nameservers:
      - https://1.1.1.1/dns-query
      - https://8.8.8.8/dns-query
    outbound: hk

  # Foreign DNS through proxy with ECS (for CDN optimization)
  proxy_ecs:
    nameservers:
      - https://n.xns.one/nK92WKAW_0A/dns-query
      - https://v.xns.one/nK92WKAW_0A/dns-query
    outbound: hk

  # Foreign DNS through proxy with ECS (for CDN optimization)
  proxy_us:
    nameservers:
      - https://n.xns.one/nK92WKAW_0A/dns-query
      - https://v.xns.one/nK92WKAW_0A/dns-query
    outbound: us


  # Domestic DNS (direct connection)
  direct:
    nameservers:
      - 10.115.15.1  # Use system resolver
    outbound: direct

# Outbound (SOCKS5 Proxies)
outbound:
  - tag: direct
    type: direct  # Built-in, no proxy

  - tag: hk
    type: socks5
    enable: true
    server: 127.0.0.1
    port: 17890
    username: hk
    password: hk
    udp: true  # Enable UDP over SOCKS5

  - tag: us
    type: socks5
    enable: true
    server: 127.0.0.1
    port: 17891
    username: us
    password: us
    udp: true

# ECS (EDNS Client Subnet) Global Configuration
ecs:
  enable: true
  default_ipv4: 113.132.219.0/24
  default_ipv6: 240e:358:a07:94c2:d589:ebf2:9d2:be0e/64
  ipv4_prefix: 24  # Send /24 prefix (hides last octet for privacy)
  ipv6_prefix: 64  # Send /64 prefix

# Cache Configuration
cache:
  dns_cache:
    enable: true
    clear: false  # IMPORTANT: Don't clear in production
    type: redis  # or: memory

  category_cache:
    enable: true
    clear: false
    type: redis
    ttl: 604800  # 7 days (categories rarely change)

# Redis Configuration
redis:
  server: 10.115.15.25
  port: 6379
  database: 7
  password: "violet-dns-secure-2024"
  max_retries: 3
  pool_size: 10

# Domain Categorization Policy
category_policy:
  preload:
    enable: true
    file: 'https://github.com/v2fly/domain-list-community/releases/latest/download/dlc.dat'
    domain_group:
      ads_site:
        - category-ads-all
      ai_site:
        - category-ai-chat-!cn
      game_domain:
        - category-games
      proxy_site:
        - google
        - geolocation-!cn
        - geolocation-cn@!cn
      direct_site:
        - cn


# Query Routing Policy (matched top-down)
query_policy:
  # Block ads and trackers
  - name: ads_site
    group: block
    options:
      block_type: nxdomain  # or: noerror, 0.0.0.0
      block_ttl: 60  # Block record TTL in seconds

  # Game domains (low latency needed)
  - name: game_domain
    group: direct
    options:
      strategy: prefer_ipv4

  - name: ai_site
    group: proxy_us
    options:
      strategy: prefer_ipv4

  # Foreign sites through proxy
  - name: proxy_site
    group: proxy
    options:
      strategy: prefer_ipv4
      expected_ips:  # Only accept non-CN IPs
        - geoip:!cn
        - geoip:private
      fallback_group: direct

  # Domestic sites direct
  - name: direct_site
    group: direct
    options:
      strategy: prefer_ipv4
      expected_ips:
        - geoip:cn

  # Unknown domains: intelligent fallback
  - name: unknown
    group: proxy_ecs_fallback
    options:
      strategy: prefer_ipv4
      auto_categorize: true  # Update category_cache based on result

# Fallback Configuration (for proxy_ecs_fallback policy)
fallback:
  geoip: 'https://raw.githubusercontent.com/Loyalsoldier/geoip/release/GeoLite2-Country.mmdb'
  asn: 'https://raw.githubusercontent.com/Loyalsoldier/geoip/release/GeoLite2-ASN.mmdb'
  update: '0 0 7 * * *'  # Update at 3 AM daily
  strategy: race  # Race both proxy_ecs and proxy
  rule:
    - geoip:cn
    - geoip:private
    - asn:4134  # China Telecom
    - asn:4837  # China Unicom
    - asn:9808  # China Mobile
  # If IP matches rule â†’ use direct, else use proxy

# Performance Configuration
performance:
  max_concurrent_queries: 1000  # Prevent query storm

# Logging Configuration
log:
  level: debug  # debug, info, warn, error
  format: json  # or: text
  output: stdout  # or: file path

  warnings:
    large_domain_groups: 10000  # Warn if group >10k domains
    many_nameservers: 10  # Warn if >10 servers per group
    clear_cache_enabled: true  # Warn if clear: true
    missing_retry: true  # Warn if retry not configured
